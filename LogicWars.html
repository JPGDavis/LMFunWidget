<html>
	<head>
		<style>
			html,body
			{
				width: 100%;
				height: 100%;
				margin: 0px;
				padding: 0px;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script>
			function Mesh(vertBuffer, lineBuffer)
			{
				 this.vertBuffer = vertBuffer;
				 this.lineBuffer = lineBuffer;
			}

			function Model(name, mesh)
			{
				this.name = name;
				this.x = 0;
				this.y = 0;
				this.z = 0;

				this.rotX = 0;
				this.rotY = 0;
				this.rotZ = 0;

				this.velX = 0;
				this.velY = 0;
				this.velZ = 0;

				this.visible = true;
				this.mesh = mesh;

				this.xLocs = new Int32Array(mesh.vertBuffer.length / 3);
				this.yLocs = new Int32Array(mesh.vertBuffer.length / 3);

				this.yLocs = new Int32Array(mesh.vertBuffer.length / 3);
			}

			var models = new Array();

			var tieVertBuffer = new Float32Array([-55.555556,-55.555556,-55.555556,
												  -55.555556,-55.555556, 55.555556,
												  -55.555556, 55.555556,-55.555556,
												  -55.555556, 55.555556, 55.555556,
												   55.555556,-55.555556,-55.555556,
												   55.555556,-55.555556, 55.555556,
												   55.555556, 55.555556,-55.555556,
												   55.555556, 55.555556, 55.555556,
												  -75.000000,-75.000000, 0.0000000,
												  -75.000000, 0.0000000,-75.000000,
												   0.0000000,-75.000000,-75.000000,
												  -75.000000, 0.0000000, 75.000000,
												   0.0000000,-75.000000, 75.000000,
												  -75.000000, 75.000000, 0.0000000,
											 	   0.0000000, 75.000000,-75.000000,
												   0.0000000, 75.000000, 75.000000,
												   75.000000,-75.000000, 0.0000000,
												   75.000000, 0.0000000,-75.000000,
												   75.000000, 0.0000000, 75.000000,
												   75.000000, 75.000000, 0.0000000,
												   0.0000000, 100.00000, 0.0000000,
												   0.0000000,-100.00000, 0.0000000,
												   0.0000000, 0.0000000, 100.00000,
												   0.0000000, 0.0000000,-100.00000,
												   100.00000, 0.0000000, 0.0000000,
												  -100.00000, 0.0000000, 0.0000000,

												   249.66158, 0.0000000, 0.0000000,
												   249.66158, 0.0000000,-203.60690,
												   249.66158, 0.0000000, 203.60690,
												   249.66158, 240.51486, 143.56864,
												   249.66158, 240.51486,-143.56864,
												   249.66158,-240.51486, 143.56864,
												   249.66158,-240.51486,-143.56864,

												  -249.66158, 0.0000000, 0.0000000,
												  -249.66158, 0.0000000,-203.60690,
												  -249.66158, 0.0000000, 203.60690,
												  -249.66158, 240.51486, 143.56864,
												  -249.66158, 240.51486,-143.56864,
												  -249.66158,-240.51486, 143.56864,
												  -249.66158,-240.51486,-143.56864]);

			for(var v = 0; v < tieVertBuffer.length; v++)
			{
				tieVertBuffer[v] *= 1;
			}

			var tieLineBuffer = new Int32Array([ 8, 25,
												25, 13,

												16, 24,
												24, 19,

												 0, 9,
												 9, 2,
												 2,14,
												14, 6,
												 6,17,
												17, 4,
												 4,10,
												10, 0,

												 1,11,
												11, 3,
												 3,15,
												15, 7,
												 7,18,
												18, 5,
												 5,12,
												12, 1,

												 9,25,
												25,11,
												11,22,
												22,18,
												18,24,
												24,17,

												10,21,
												21,12,
												12,22,
												22,15,
												15,20,
												20,14,

												 0, 8,
												 8, 1,

												 2,13,
												13, 3,

												 4,16,
												16, 5,

												6,19,
												19, 7,

												 0,23,
												 9,23,
												 2,23,
												14,23,
												 6,23,
												17,23,
												 4,23,
												10,23,

												 8,21,
												21,16,
												13,20,
												20,19,

												31,32,
												32,27,
												27,30,
												30,29,
												29,28,
												28,31,
												29,26,
												30,26,
												31,26,
												32,26,

												16,26,
												19,26,

												38,39,
												39,34,
												34,37,
												37,36,
												36,35,
												35,38,
												36,33,
												37,33,
												38,33,
												39,33,

												8 ,33,
												13,33]);

			var tieMesh = new Mesh(tieVertBuffer, tieLineBuffer);
			var tieModel = new Model("tieFighter", tieMesh);
			tieModel.z = -1;
			models.push(tieModel);

			// Lazers

			var lazerVertBuffer = new Float32Array([0, 0,-200,
												    0, 0, 200]);

			var lazerLineBuffer = new Int32Array([0,1]);

			var lazerMesh = new Mesh(lazerVertBuffer, lazerLineBuffer);

			for(var i = 0; i <= 10; i++)
			{
				var lazerModel = new Model("lazer", lazerMesh);
				lazerModel.visible = false;
				lazerModel.z = -100;
				lazerModel.velZ = 5;
				models.push(lazerModel)
			}

			//

			var deathStarVertBuffer = new Float32Array([250 , 250, 1000,
													   -250 , 250, 1000,
													    250 , 250, 0,
													   -250 , 250, 0,
													    250 ,-250, 1000,
													   -250 ,-250, 1000,
													    250 ,-250, 0,
													   -250 ,-250, 0,
													    2000,-250, 0,
													   -2000,-250, 0]);

			var deathStarLineBuffer = new Int32Array([2,3,
												 2,0,
												 3,7,
												 7,5,
												 3,1,
												 2,6,
												 6,4,
												 6,8,
												 7,9]);


			var deathStarMesh = new Mesh(deathStarVertBuffer, deathStarLineBuffer);

			for(var i = 0; i <= 10; i++)
			{
				var deathStarModel = new Model("deathStar", deathStarMesh);
				deathStarModel.y = 400;
				deathStarModel.z = (1000 * i);
				deathStarModel.velZ = -2;
				models.push(deathStarModel)
			}

			// Stars

			var starVertBuffer = new Float32Array(300);

			for(var s = 0; s < 300; s += 3)
			{
				starVertBuffer[s] = (Math.random() - 0.5) * 250000;
				starVertBuffer[s + 1] = (Math.random() - 0.5) * 60000;
				starVertBuffer[s + 2] = (Math.random() - 0.5) * 50000;
			}

			var starModel = new Model("stars", new Mesh(starVertBuffer,null));
			starModel.y = -30000;
			starModel.z = 100000;
			models.push(starModel)

			// Explosion

			var explodeVertBuffer = new Float32Array(300);

			for(var s = 0; s < explodeVertBuffer.length; s += 3)
			{
				explodeVertBuffer[s] = (Math.random() - Math.random()) * 500;
				explodeVertBuffer[s + 1] = (Math.random() - Math.random()) * 500;
				explodeVertBuffer[s + 2] = (Math.random() - Math.random()) * 500;
			}

			var explodeModel = new Model("explode", new Mesh(explodeVertBuffer,null));
			explodeModel.visible = false;
			explodeModel.y = 0;
			explodeModel.z = 2000;
			models.push(explodeModel)

			var time;
			var shakeOffetX = 0;
			var shakeOffetY = 0;

			var cnv = document.getElementById('canvas');
			var focalLength = cnv.height;

			var ctx = cnv.getContext('2d');
			ctx.lineWidth = 2;
			ctx.lineCap = "round";

			var cameraX = 0;
			var cameraY = 0;

			function update(delta)
			{
				for (var i = 0; i < models.length; i++)
				{
					var model = models[i];

					model.x += (delta * model.velX);
					model.y += (delta * model.velY);
					model.z += (delta * model.velZ);

					if(model.name == "explode")
					{
						// Reset close tile pieces
						if(model.y > 5000)
						{
							model.visible = false;
							model.velY = 0;
						}
					}

					if(model.name == "lazer")
					{
						// Reset close tile pieces
						if(model.z > 10000)
						{
							model.visible = false;
						}
					}

					if(model.name == "deathStar")
					{
						// Reset close tile pieces
						if(model.z < -1000)
						{
							model.z += (1000 * 11)
						}
					}

					if(model.name == "tieFighter")
					{
						if(model.z < 0)
						{
							model.z = 20000;
							model.x = (Math.random() * 10000) - 5000;
							model.rotY = model.x / 8000;

							model.velX = -(model.x / 8000);
							model.velZ = -4;

							model.visible = true;
						}

						// model.y = -((Math.sin((model.z / 4000) + -1) * 2000) + 1500);
						model.rotX = (model.z / 10000);
						model.y = (Math.sin((model.z / 10000) + 1.5) * 10000) - 10000;
					}

					// Collision Detection
					if(model.visible && model.name == "lazer")
					{
						if(tieModel.visible)
						{
							if(Math.abs(tieModel.x - model.x) < 500 &&
							   Math.abs(tieModel.y - model.y) < 500 &&
							   Math.abs(tieModel.z - model.z) < 500)
							{
								// Ship hit!
								model.visible = false;
								tieModel.visible = false;

								explodeModel.visible = true;

								explodeModel.x = tieModel.x;
								explodeModel.y = tieModel.y;
								explodeModel.z = tieModel.z;

								explodeModel.velX = tieModel.velX;
								explodeModel.velZ = tieModel.velZ;

								explodeModel.velY = 1.5;

								var xhr = new XMLHttpRequest();
								xhr.open("GET", "https://cors-anywhere.herokuapp.com/http://www.theowly1.com/LogicWars/LogicWars.php?action=hit", true);
								xhr.send(null);
							}
						}
					}
				}
			}

			function transform()
			{
				// Bounds
				var xOffset = cnv.width	/ 2;
				var yOffset = cnv.height / 2;

				// Transform Models
				for (var i = 0; i < models.length; i++)
				{
					var model = models[i];

					if(model.visible)
					{
						for(var v = 0; v < model.mesh.vertBuffer.length; v += 3)
						{
							var vertNum = v / 3;

							var x = model.mesh.vertBuffer[v];
							var y = model.mesh.vertBuffer[v + 1];
							var z = model.mesh.vertBuffer[v + 2];

							// Shake the camera
							shakeOffetX = (Math.sin(time / 2345) * 200);
							shakeOffetY = (Math.sin(time / 4532) * 100);
							
							x += shakeOffetX;
							y += shakeOffetY;

							// Rotate X;
							if(model.rotX != 0)
							{
								var sinRot = Math.sin(model.rotX);
								var cosRot = Math.cos(model.rotX);

								var pY = y;
								y = y * cosRot - z * sinRot;
								z = pY * sinRot + z * cosRot;
							}

							// Rotate Y;
							if(model.rotY != 0)
							{
								var sinRot = Math.sin(model.rotY);
								var cosRot = Math.cos(model.rotY);

								var pX = x;
								x = x * cosRot + z * sinRot;
								z = z * cosRot - pX * sinRot;
							}

							// Calculate depth
							var depth = focalLength / (focalLength + (z + model.z))

							if(depth < 5 && depth > 0)
							{
								model.xLocs[vertNum] = ((x + model.x) * depth) + xOffset;
								model.yLocs[vertNum] = ((y + model.y) * depth) + yOffset;

								model.xLocs[vertNum] = ((x + model.x) * depth) + cameraX + xOffset;
								model.yLocs[vertNum] = ((y + model.y) * depth) + cameraY + yOffset;
							}
						}
					}
				}
			}

			function render()
			{
				ctx.beginPath();
				ctx.strokeStyle = "#ffffff";
				ctx.fillStyle = "#ffffff";

				for (var i = 0; i < models.length; i++)
				{
					var model = models[i];

					if(model.visible)
					{
						if(model.mesh.lineBuffer)
						{
							for(var l = 0; l < model.mesh.lineBuffer.length; l += 2)
							{
								var st = model.mesh.lineBuffer[l];
								var ed = model.mesh.lineBuffer[l + 1];

								
								ctx.moveTo(model.xLocs[st],model.yLocs[st]);
								ctx.lineTo(model.xLocs[ed],model.yLocs[ed]);
								
							}
						}
						else
						{
							for(var s = 0; s < model.mesh.vertBuffer.length / 3; s++)
							{
								
								ctx.moveTo(model.xLocs[s],model.yLocs[s]);
								ctx.lineTo(model.xLocs[s] + 1,model.yLocs[s] + 1);
							}
						}
					}
				}

				ctx.stroke();
			}

			function frame()
			{
				cnv.width  = window.innerWidth;
				cnv.height = window.innerHeight;
				focalLength = cnv.height;

				// Time
				var now = new Date().getTime();
				var delta = now - (time || now);
				
				time = now;

				// Clearing
				ctx.rect(0, 0, cnv.width, cnv.height);
				ctx.fillStyle = "#1D2841"//"#222B42";
				ctx.fill();

				update(delta);
				transform();
				render();

				requestAnimationFrame(frame);
			}

			function mouseMoved(event)
			{
				cameraX = -(event.clientX - (window.innerWidth / 2)) * 0.5;
				cameraY = -(event.clientY - (window.innerHeight / 2)) * 0.5;
			}

			var lazerPos = 0;

			function mouseUp(event)
			{
				for (var i = 0; i < models.length; i++)
				{
					var model = models[i];

					if(!model.visible && model.name == "lazer")
					{
						switch(lazerPos)
						{
							case 0:
								model.x = -100;
								model.y = -100;
								break;
							case 1:
								model.x = 100;
								model.y = 100;
								break;
							case 2:
								model.x = -100;
								model.y = 100;
								break;
							case 3:
								model.x = 100;
								model.y = -100;

								lazerPos = -1;
								break;
						}

						model.x -= shakeOffetX;
						model.y -= shakeOffetY;

						lazerPos++;

						model.velX = -(cameraX / 30);
						model.velY = -(cameraY / 30);

						model.rotX = (-model.velY / 6)
						model.rotY = (model.velX / 7)

						model.z = -100;
						model.visible = true;

						i = 20;
					}
				}
			}

			cnv.onmouseup = mouseUp;

			document.onmousemove = mouseMoved;
			requestAnimationFrame(frame);
		</script>
	</body>
</html> 